{"version":3,"sources":["../../../../../../src/CommunicationSystem/SocketCommunicationSystem/ZeroMQ/Server/AZeroMQServerLight.ts"],"names":["AZeroMQServerLight","mode","CONSTANT","ZERO_MQ","MODE","SERVER","ipServer","DEFAULT_SERVER_IP_ADDRESS","portServer","DEFAULT_SERVER_IP_PORT","socketType","SOCKET_TYPE","OMQ_PULL","transport","TRANSPORT","TCP","identityPrefix","SERVER_IDENTITY_PREFIX","PromiseCommandPattern","func","Promise","resolve","reject","active","socket","check","some","x","Errors","zmq","identity","process","pid","startMonitor","bind","err","console","error","stopMonitor","treatMessageFromClient","on","KEYWORDS_OMQ","CLOSE","CLOSE_ERROR","ep","String","close","MESSAGE","msg","dataString","Utils","fireUp","incomingMessageListeningFunction","AZeroMQ"],"mappings":"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","sourcesContent":["//\n// Copyright (c) 2016 by Cotep. All Rights Reserved.\n//\n\n// Imports\nimport zmq from 'zeromq';\nimport CONSTANT from '../../../../Utils/CONSTANT/CONSTANT.js';\nimport AZeroMQ from '../AZeroMQ.js';\nimport Utils from '../../../../Utils/Utils.js';\nimport Errors from '../../../../Utils/Errors.js';\nimport PromiseCommandPattern from '../../../../Utils/PromiseCommandPattern.js';\n\n/**\n * Server used when you have Unidirectionnal server (like PULL)\n */\nexport default class AZeroMQServerLight extends AZeroMQ {\n  constructor() {\n    super();\n\n    // Mode we are running in\n    this.mode = CONSTANT.ZERO_MQ.MODE.SERVER;\n  }\n\n  /**\n   * Start a ZeroMQ Server\n   * @param {{ipServer: String, portServer: String, socketType: String, transport: String, identityPrefix: String}} args\n   */\n  startServer({\n    ipServer = CONSTANT.ZERO_MQ.DEFAULT_SERVER_IP_ADDRESS,\n    portServer = CONSTANT.ZERO_MQ.DEFAULT_SERVER_IP_PORT,\n    socketType = CONSTANT.ZERO_MQ.SOCKET_TYPE.OMQ_PULL,\n    transport = CONSTANT.ZERO_MQ.TRANSPORT.TCP,\n    identityPrefix = CONSTANT.ZERO_MQ.SERVER_IDENTITY_PREFIX,\n  }) {\n    return new PromiseCommandPattern({\n      func: () => new Promise((resolve, reject) => {\n        // If the server is already up\n        if (this.active) return resolve(this.socket);\n\n        // Check the socket Type\n        const check = [\n          CONSTANT.ZERO_MQ.SOCKET_TYPE.OMQ_PULL,\n          // ... add here is required\n        ].some(x => x === socketType);\n\n        if (!check) return reject(new Errors('E2008', `socketType: ${socketType}`));\n\n        // Create the server socket\n        this.socket = zmq.socket(socketType);\n\n        // Set an identity to the server\n        this.socket.identity = `${identityPrefix}_${process.pid}`;\n\n        // Start the monitor that will listen to socket news\n        this.startMonitor();\n\n        // Bind the server to a port\n        return this.socket.bind(`${transport}://${ipServer}:${portServer}`, (err) => {\n          if (err) {\n            // Log something\n            console.error(`Server ZeroMQ Bind Failed. Transport=${transport} Port=${portServer} IP:${ipServer}`);\n\n            // Stop the monitoring\n            this.stopMonitor();\n\n            // Remove the socket\n            delete this.socket;\n\n            this.socket = false;\n            this.active = false;\n\n            // Return an error\n            return reject(new Errors('E2007', `Specific: ${err}`));\n          }\n\n          // Start to handle client messages\n          this.treatMessageFromClient();\n\n          this.active = true;\n\n          // We successfuly bind the server\n          return resolve(this.socket);\n        });\n      }),\n    });\n  }\n\n  /**\n   * Stop a ZeroMQ Server\n   */\n  stopServer() {\n    return new PromiseCommandPattern({\n      func: () => new Promise((resolve, reject) => {\n        // If the server is already down\n        if (!this.active) return resolve();\n\n        // Listen to the closure of the socket\n        this.socket.on(CONSTANT.ZERO_MQ.KEYWORDS_OMQ.CLOSE, () => {\n          // Successfuly close\n          // Stop the monitoring\n          this.stopMonitor();\n\n          // Delete the socket\n          delete this.socket;\n\n          this.socket = false;\n          this.active = false;\n\n          return resolve();\n        });\n\n        // Error in closure\n        this.socket.on(CONSTANT.ZERO_MQ.KEYWORDS_OMQ.CLOSE_ERROR, (err, ep) =>\n          reject(new Errors('E2006', `Endpoint: ${String(err)} - ${ep}`)));\n\n        // Ask for closure\n        return this.socket.close();\n      }),\n    });\n  }\n\n  /**\n   * Treat messages that comes from clients\n   * send them to the listeners)\n   */\n  treatMessageFromClient() {\n    this.socket.on(CONSTANT.ZERO_MQ.KEYWORDS_OMQ.MESSAGE, (msg) => {\n      const dataString = String(msg);\n\n      Utils.fireUp(this.incomingMessageListeningFunction, [dataString]);\n    });\n  }\n}\n"],"file":"AZeroMQServerLight.js"}